(function () {
  var u = Katana.utils;

  Katana.Builder = (function() {
    
    function Builder(opts) {
      if (opts == null) {
        opts = {};
      }
      if (opts.data) {
        this.data = opts.data;
      }
      this.data = { '17mm67p66r': { name: '17mm67p66r', index: 0, type: 0 },
  '9lcqevobt9': 
   { type: 10,
     name: '9lcqevobt9',
     index: 0,
     section: '17mm67p66r',
     tag: 'h3',
     text: 'A Wrong Decision',
     markups: [] },
  '4palv26gvi': 
   { type: 10,
     name: '4palv26gvi',
     index: 2,
     section: '17mm67p66r',
     tag: 'p',
     text: '',
     markups: [] },
  d7b96enrk9: 
   { type: 12,
     name: 'd7b96enrk9',
     index: 1,
     section: '17mm67p66r',
     tag: 'figure',
     text: '',
     empty: true,
     meta: 
      { resourceId: '55da3a90453852546f83fdb0',
        resourceUrl: '/fullsize/01933f57373e8c841440365200913.jpeg',
        resourceMarkup: [Object],
        pos: 1,
        partial: false,
        link: false } },
  vm0tvp9zfr: 
   { type: 10,
     name: 'vm0tvp9zfr',
     index: 3,
     section: '17mm67p66r',
     tag: 'p',
     text: 'Met Priya (name changed) today. She is a member of this forum, and wanted me to share her story with all of you.',
     markups: [] },
  pevi3k57b9: 
   { type: 10,
     name: 'pevi3k57b9',
     index: 4,
     section: '17mm67p66r',
     tag: 'p',
     text: '3 months ago Priya got engaged to Mohan (name changed). They instantly developed a great chemistry. The first anxious meetings, slowly turned into a comfortable relationship.Going out for movies, meeting up for coffee, introducing each other to their friends.',
     markups: [] },
  oc45fxn7b9: 
   { type: 10,
     name: 'oc45fxn7b9',
     index: 5,
     section: '17mm67p66r',
     tag: 'p',
     text: 'A month ago, Mohan tried to get too close and openly asked that they both should have sex. She denied and wanted to do it only after marriage. A small fight later, things seemed back to normal. But now every 2nd day Mohan would bring out the topic in some way or other. Be it giving example of some friends, sarcasm or criticising the old indian laws regarding pre-marital sex. 2 weeks ago, he tried to force himself. Priya again denied, this time he got aggressive pushed her so hard that she fell and fractured her wrist.',
     markups: [] },
  ge69vhd7vi: 
   { type: 10,
     name: 'ge69vhd7vi',
     index: 6,
     section: '17mm67p66r',
     tag: 'p',
     text: 'At home, Mohan created a big story through which he gained a lot of sympathy.',
     markups: [] },
  s38cjo47vi: 
   { type: 10,
     name: 's38cjo47vi',
     index: 7,
     section: '17mm67p66r',
     tag: 'p',
     text: 'Priya left traumatised by the incident, decided to call off the marriage.',
     markups: [] },
  s09ttke29: 
   { type: 10,
     name: 's09ttke29',
     index: 8,
     section: '17mm67p66r',
     tag: 'p',
     text: 'When she told the reason to her mother, she shouted at her. She complained how she couldn\'t handle this situation. Now 2 weeks from the wedding their name will be destroyed in society.',
     markups: [] },
  ul9vd3g14i: 
   { type: 10,
     name: 'ul9vd3g14i',
     index: 9,
     section: '17mm67p66r',
     tag: 'p',
     text: 'When told to her father, he blasted her for creating stories. He said Mohan was such a caring chap..Priya was just being fearful.',
     markups: [] },
  wbpvfv42t9: 
   { type: 10,
     name: 'wbpvfv42t9',
     index: 10,
     section: '17mm67p66r',
     tag: 'p',
     text: 'Her brother stood by her.',
     markups: [] },
  sd4j0b2o6r: 
   { type: 10,
     name: 'sd4j0b2o6r',
     index: 11,
     section: '17mm67p66r',
     tag: 'p',
     text: 'When Mohan family was told about the situation they went into an anger fit.!Mohan denied any such incident and stood by his story. Everyone blamed it on Priya.One relative publically acussed her for having an affair somewhere else.',
     markups: [] },
  c347808uxr: 
   { type: 10,
     name: 'c347808uxr',
     index: 12,
     section: '17mm67p66r',
     tag: 'p',
     text: 'Mohan secretly called her - apologised half-heartedly, blamed her for not understanding his "love", asked her to take all blame, let go of everything so both of them can start their new life. He promised he would take care of his parents.',
     markups: [] },
  m30rpe3ik9: 
   { type: 10,
     name: 'm30rpe3ik9',
     index: 13,
     section: '17mm67p66r',
     tag: 'p',
     text: 'Priya finally called off the marriage, but not before consuming half bottle of phenyl (floor disinfectant).. Burning half her stomach and battling death in the ICU for 3 days.',
     markups: [] },
  zhjdtb7qfr: 
   { type: 10,
     name: 'zhjdtb7qfr',
     index: 14,
     section: '17mm67p66r',
     tag: 'p',
     text: 'Today her parents brought her to my consultancy. The parents where angry on her.',
     markups: [] },
  '1sps73z0k9': 
   { type: 10,
     name: '1sps73z0k9',
     index: 15,
     section: '17mm67p66r',
     tag: 'p',
     text: 'But when i spoke to Priya, i found a very strong girl whose heart was broken by everyone who called themselves as " well-wishers".',
     markups: [] },
  vey8ccjtt9: 
   { type: 10,
     name: 'vey8ccjtt9',
     index: 16,
     section: '17mm67p66r',
     tag: 'p',
     text: 'At the end of my counseling session, in her weak voice she said - " Doc, can i ask you for a favor. Please share my story with the entire world. There are a million of Priyas out there. I just want to tell them - i was wrong in trying to kill myself.. But i was very right in standing up for myself. When i was in the ICU, with all those tubes in my body.. I just realized.. No one will care for me, everyone just cares for their idiotic social laws. Which they break every day, but still live behind them like hypocrites. I matter.. And only i can take care of myself.I learned to love my life in the difficult way, i want others to understand it before its too late ".',
     markups: [] },
  t2rch7u8fr: 
   { type: 10,
     name: 't2rch7u8fr',
     index: 17,
     section: '17mm67p66r',
     tag: 'p',
     text: 'On a Personal note - i would like to thank Priya for meeting me. She is beautiful soul and in her eyes, i saw the empowerment i wish every human being carries. The power of loving your self.',
     markups: [] },
  oozinng66r: 
   { type: 10,
     name: 'oozinng66r',
     index: 18,
     section: '17mm67p66r',
     tag: 'p',
     text: '-Dr.Hemant Mittal (psychiatrist, motivational writer and social influencer)eksoch@gmail.com',
     markups: [] } };

      this.initialize.apply(this, arguments);
    }

    Builder.prototype.initialize = function(opts) {
      this.compileTemplates();
      this.segregateData();
      this.paint();
      return this;
    };

    Builder.prototype.compileTemplates = function () {
      Handlebars.registerHelper('if_eq', function(a, b, opts) {
        if(a == b) {
          return opts.fn(this);
        } else {
          return opts.inverse(this);
        }
      });

      Handlebars.registerHelper('if_eq_either', function (a, b, c, opts) {
        if(a == b || a == c) {
          return opts.fn(this);
        } else {
          return opts.inverse(this);
        }
      });

      this.template = Handlebars.compile($('#template_st_main').html()); // main template

      Handlebars.registerPartial('defaultSection', $('#template_st_section').html()); // default section partial
      Handlebars.registerPartial('imageSection', $('#template_st_section_with_picture').html());
      Handlebars.registerPartial('videoSection', $('#template_st_section_with_video').html()); // section with video background

      Handlebars.registerPartial('sectionContent', $('#template_st_section_content').html());
      
      Handlebars.registerPartial('figureSelect', $('#template_st_figure_select').html());
      Handlebars.registerPartial('figure', $('#template_st_figure').html());
      Handlebars.registerPartial('iframe', $('#template_st_figure_with_iframe').html());
      Handlebars.registerPartial('multipleFigure', $('#template_st_multilple_figures').html());
      Handlebars.registerPartial('fullSizeFigure', $('#template_st_full_with_image').html());
      Handlebars.registerPartial('list', $('#template_st_list').html());
      Handlebars.registerPartial('item', $('#template_st_item').html());
    };

    Builder.prototype.segregateData = function () {
      var firstPass = {}; // after first pass, this object ll contains key => sectionName, value => {section: 'name', content: [], info: sectionInfo};

      for(var prop in this.data) {
        if (this.data.hasOwnProperty(prop)) {
          var item = this.data[prop]
              type = item.type,
              name = item.name;
              if (type >=0 && type <= 3) { // section we got
          if (typeof firstPass[name] == 'undefined') {
            var ob = {
                section: name,
                content: [],
                info: item
              };
              firstPass[name] = ob;
            } else {
              firstPass[name].info = item;
            }
          } else {
            if (typeof firstPass[item.section] == 'undefined') {
              firstPass[item.section] = {section: name, content: []};
            }
            firstPass[item.section].content[item.index] = item;
          }
        }
      }

      var items = [];
      for(var prop in firstPass) {
        if (firstPass.hasOwnProperty(prop)) {
          var item = firstPass[prop];
          var info = item.info;
          items[info.index] = item;
        }
      }
      this.parsedData = {};
      this.parsedData.items = items;
      
    };

    Builder.prototype.paint = function () {
      var html = this.template(this.parsedData);
      console.log(html);
    };

    return Builder;

  })();
}).call(this);
